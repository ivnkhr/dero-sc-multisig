<html>
  <head>
    <script
      src="https://code.jquery.com/jquery-3.3.1.min.js"
      integrity="sha256-FgpCb/KJQlLNfOu91ta32o/NMZxltwRo8QtmkMRdAu8="
      crossorigin="anonymous"></script>
	<link href="https://fonts.googleapis.com/css?family=Major+Mono+Display|Sarabun" rel="stylesheet">
	<script
		src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/0.7.3/p5.min.js"></script>
    <style>
      body{
        background-color: #333;
		font-family: 'Major Mono Display', monospace;
      }
      .row{
        display: flex;
      }
      .col{
        flex: 50%;
      }
	  .contract-box{
		padding: 20px;
		margin: 20px auto;
		border: 2px solid white;
		box-shadow: 0px 0px 6px 0px black;
		width: 560px;
		background-color: #eee;
	  }
	  h2{
		color: black;
	  }
	  .input-state{
		margin: 5px;
		margin-bottom: 10px;
	  }
	  .input-state span{
		font-family: 'Sarabun', sans-serif;
		color: #999;
		position: relative;
		z-index: 999;
	  }
	  .input-state input{
		margin-top: 1px;
		font-family: 'Sarabun', sans-serif;
		background-color: #ccc;
		border: 0;
		padding: 5px;
		border-bottom: 2px solid white;
		width: 100%;
	  }
	  
	  .methods{
		border-radius: 6px;
		padding: 5px;
		border: 2px solid white;
		background-color: #e3e3e3;
	  }
	  
	  .methods .button{
		background-color: #49ff7d;
		font-family: 'Sarabun', sans-serif;
		margin: 5px;
		border-radius: 4px;
		border: 2px solid white;
		padding: 5px;
		text-align: center;
		cursor: pointer;
		font-weight: normal;
		font-size: 18px;
		transition: all 0.6s ease 0s;
	  }
	  .methods .button:hover{
		background-color: white;
		padding: 10px;
	  }
	  .methods .button.active{
	  	background-color: #eee;
		padding: 10px;
		text-decoration: underline;
		border: 2px solid #999;
	  }
	  .tbl{
	  
	  width: 100%;
	  
	  }
	  .pre{
	  font-family: 'Calibri', sans-serif;
	      overflow-wrap: break-word;
    text-overflow: ellipsis;
	background-color: black;
	border: 1px solid lime;
	color: white;
	padding: 5px;
	  }

    </style>
	<script>
	// https://plrspro.github.io/dero-sc-multisig/contract.bas	
  
  wallet_rpc = '';
  daemon_rpc = 'http://127.0.0.1:30306/';
  scid = '4d8a11105e809e756cc664fa36b895aa31bf39423b0527a3d83d12932b51531f';
  //http://206.189.61.167:30306/json_rpc
  
  var latest_call = '';
  var last_subj = '';
  
	$(document).ready(function(){
		
    $('.daemon_rpc').val(daemon_rpc);
    $('.scid').each(function(){
      $(this).val(scid);
    });
    //ping daemon
    test_remote_daemon = 'http://206.189.61.167:30306/';
    $.ajax({
         url: test_remote_daemon+'json_rpc',
         success: function(result){
            $('.daemon_rpc').val(test_remote_daemon);
            get_tx_sc_val([]);
         },     
         error: function(result){
            get_tx_sc_val([]);
         }
      });
    
    //["acba33e3530c653e379d0fe58636fa6622b7cec7bf9082a3e96f4f0053564bb8_locked"]
    
    function get_tx_sc_val(keys){
      
      $('.pre2').html("Loading...");
      
      copm_tx = {
        "txs_hashes": [scid],
        "sc_keys": keys
      }
      
      
      $.ajax({
       url: $('.daemon_rpc').val()+"gettransactions", 

       data: JSON.stringify (copm_tx),  // id is needed !!

       type:"POST",

       dataType:"json",
       success:  function (data)       { 
       
         if(keys.length==0){
           text  = "Contract balance: "+(data.txs[0].sc_balance/1000000000000)+' DERO<br/>';
           text += "Deployed at "+data.txs[0].block_height+" height"+"<hr/>";
           text += 'Methods availiable:<br/>';
           Object.keys(data.txs[0].sc.F).forEach(function(key) {
             text += key+"<br/>";
           });
           
           $('.pre2').html(text);
         }else{
           
           text = latest_call+"<br/>";
           
           if( data.txs[0].sc_keys[Object.keys(data.txs[0].sc_keys)[0]] == "" ){
             text += "Not Found (your transaction might not get mined yet, please wait and retry)";
           }else{
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             text += "Original creator: "+(data.txs[0].sc_keys[last_subj]);
             
             //text += JSON.stringify(data.txs[0].sc_keys).split(last_subj).join("*");
           }

           $('.pre2').html(text);
         }
      
         //alert("The result is : " + );
         
       
       },
       error: function (err)  { $('.pre2').text('Failed to communicate with daemon'); }

     });     
      
      //prep_data = "{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"gettransactions\",\"params\":"+(JSON.stringify(copm_tx))+"}";
    //  prep_data = JSON.stringify(prep_data);
      //$('.pre').text("curl -X GET "+($('.daemon_rpc').val())+" -H \"Content-Type: application/json\" -d "+prep_data);
      
    }
    
    
    
		function wallet_call()	{
		
			scid = $('#scid').val();
		

		
			 $.ajax({
				url: $('.wallet_rpc').val(), 

				data: JSON.stringify ({jsonrpc:'2.0',id:0,method:'transfer_split',params:copm_tx}),  // id is needed !!

				type:"POST",

				dataType:"json",
				success:  function (data)       { 
				
					alert("The result is : " + data.result);
				
				},
				error: function (err)  { alert ("Error"); }

			});
		};
		
    $('.act2').click(function(){
      
      latest_call = $(this).attr('data-command-act');
      
      var subj = prompt("Please enter your `dero multisig walelt` id", "");
      last_subj = subj;
      
      if($(this).attr('data-command-act')=="Wallet"){
        props = [subj,subj+'_balance',subj+'_locked',subj+'_signer_index'];
        props.push(subj+"_signer_0");
        props.push(subj+"_signer_1");
        props.push(subj+"_signer_2");
        props.push(subj+"_signer_3");
        props.push(subj+"_signer_4");
        props.push(subj+"_signer_5");
        props.push(subj+"_signer_6");
        props.push(subj+"_signer_7");
        props.push(subj+"_signer_8");
        get_tx_sc_val(props);
      }
      if($(this).attr('data-command-act')=="Transaction"){
        get_tx_sc_val([
          'transaction_'+subj,
          'transaction_'+subj+'_amount',
          'transaction_'+subj+'_wallet',
          'transaction_'+subj+'_executed'
        ]);
      }
      
    });
    
		$('.act1').click(function(){
			//$(this).toggleClass('active');
			sc = $(this).data('command');
			
			
			if( sc == 'Execute' ){
				command = $(this).data('command');
				//wallet_call(active_cmd,{});
				
				scid = $('#scid').val();
				
				copm_tx = {
					"mixin":5,
					"get_tx_key":true,
					"sc_tx":
					{
						"entrypoint":active_cmd,
						"scid":scid,
					}
				};
				
				/*
				vc_val = $('#params .params#value').val()
				if(vc_val){
					copm_tx.sc_tx.value = vc_val;
				}
				
				copm_tx.sc_tx.params = {};
				*/
				
				copm_tx.sc_tx.params = {};
				
				$( "#params .params" ).each(function( index ) {
				  console.log( $( this ).attr('id') + ": " + $( this ).val() );
				  
				  dc_val = '';
				  if( $( this ).attr('type') == 'number' ){
					dc_val = parseInt($( this ).val());
				  }else{
					dc_val = $( this ).val();
				  }
				  
				  	//vc_val = ;
					if($( this ).attr('id')=='value'){
						copm_tx.sc_tx.value = parseInt($( this ).val())*1000000000000;
					}else{
					  copm_tx.sc_tx.params[$( this ).attr('id')]=  dc_val;
					}
				});
				
				if( Object.keys(copm_tx.sc_tx.params).length === 0 ) delete copm_tx.sc_tx.params;
				
				//$('#params .params').each
				
        prep_data = "{\"jsonrpc\":\"2.0\",\"id\":\"0\",\"method\":\"transfer_split\",\"params\":"+(JSON.stringify(copm_tx))+"}";
				prep_data = JSON.stringify(prep_data);
				$('.pre1').text("curl -X POST "+($('.wallet_rpc').val())+" -H \"Content-Type: application/json\" -d "+prep_data);
				
				$('.pre1').show();
			}else{
				active_cmd = sc;
				$('#params').html("");
				if(active_cmd){
					$('.pre1').hide();
					$('#confirm').show();
					params = $(this).data('params');
					if(params){
						a = params.split(',');
						for (i = 0; i < a.length; i++) {
							def = (a[i]);
							type = 'text';
							if( def == 'value' || def == 'amount' ){
								type = 'number';
							}else{
							
							}
							lable = a[i];
							if(lable=='wallet'){
								lable = 'wallet (contract wallet id)';
							}
							if(lable=='signer'){
								lable = 'signer (valid DERO address)';
							}
							if(lable=='destination'){
								lable = 'destination (valid DERO address)';
							}
							if(lable=='value' || lable=='amount'){
								lable = 'amount (in DERO)';
							}
							if(lable=='transaction'){
								lable = 'transaction (contract transaction id)';
							}
							$('#params').append('<div class="input-state"><span>'+(lable)+'</span><input type="'+type+'" class="params" id="'+a[i]+'" value=""/></div>');
						}
					}
				}
			}
		});
		
		//curl -X POST http://127.0.0.1:30309/json_rpc -H 'Content-Type: application/json' -d '{"jsonrpc":"2.0","id":"0","method":"transfer_split","params":{"mixin":5,"get_tx_key":true,"sc_tx":{"entrypoint":"Lottery","scid":"ab82caa18753efa0f76e7266af7fdd7f11e0ada5e135bd63f1cd823f5e2c2fdc","value":4000000000000}}}'
		
		/*
		{
			"jsonrpc":"2.0",
			"id":"0",
			"method":"transfer_split",
			"params":
				{
				"mixin":5,
				"get_tx_key":true,
				"sc_tx":
					{
					"entrypoint":"WalletCreateAndLockWithOneAdditionalSigner",
					"scid":"{{scid}}",
					"params":
						{ 
						"signer1": "{{wallet_addr2}}"
						} 
					}
				}
		}
		*/
	});
	</script>
  </head>
  <body>
  
  <table class="tbl"><tr><td valign="top">
  
    <div class="contract-box">
      <h2>`dero multisig interact`</h2>
	  
	  <div class="input-state">
		  <span>wallet rpc path</span>
		  <input type="text" class="wallet_rpc" value="http://127.0.0.1:30307/json_rpc"/>
	  </div>
	  
	  <div class="input-state">
		  <span>scid</span>
		  <input disabled type="text" id="scid" class="scid" value=""/>
	  </div>
	  
	  <br/>
	   <h2>`availiable operations`</h2>
	  <div class="methods">
      <h5><center>wallet commands</center></h5>
		<div class="button act1" data-command="WalletCreate">1. Setup Wallet</div>
		<div class="button act1" data-command="WalletAddSigner" data-params="wallet,signer">2. Add Signer to a Wallet</div>
		<div class="button act1" data-command="WalletLock" data-params="wallet">3. Finalize Wallet</div>
		<div class="button act1" data-command="WalletDeposit" data-params="wallet,value">4. Deposit Funds to a Wallet</div>
		<br/>
      <h5><center>transaction commands</center></h5>
		<div class="button act1" data-command="TransactionCreateSendHumanReadableAmount" data-params="wallet,destination,amount">Send Funds</div>
    <center>or</center>
		<div class="button act1" data-command="TransactionSign" data-params="transaction">Sign Transaction</div>
	  </div>
	  
	  <section id="confirm" style="display: none;">
	  <br/>
	   <h2>`confirm interaction`</h2>

	  <div class="methods">
	  
	  <div id="params"></div>
	  
	  <div class="button act1" data-command="Execute">Construct Transaction</div>
	  </div>
	  <br/>
<div class="pre pre1" style="display: none;">

</div>
		<!--<div class="button" data-command="Execute">Submit Transaction</div>-->

	  </section>
	  
    </div>
	
	</td>
	<td valign="top">
	
	
    <div class="contract-box">
      <h2>`dero multisig verify`</h2>
	  
	  <div class="input-state">
		  <span>daemon rpc path</span>
		  <input type="text" class="daemon_rpc" value=""/>
	  </div>
	  
	  <div class="input-state">
		  <span>scid</span>
		  <input disabled type="text" id="scid" class="scid" value=""/>
	  </div>
	  
	  <br/>
	   <h2>`availiable operations`</h2>
	  <div class="methods">
		<div class="button act2" data-command-act="Wallet">View Wallet Status</div>
		<div class="button act2" data-command-act="Transaction">View Transaction Status</div>
	  </div>
	  
	  <section id="confirm">
	  <br/>
	   <h2>`contract state`</h2>

	  
<div class="pre pre2">
Loading...
</div>
		<!--<div class="button" data-command="Execute">Submit Transaction</div>-->

	  </section>
	  
    </div>
	
	
	</td>
	</tr>
	</table>
	
	
  </body>
</html>
